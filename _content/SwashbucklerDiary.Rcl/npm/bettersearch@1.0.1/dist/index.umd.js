!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).BetterSearch=t()}(this,function(){"use strict";function s(e){return 1===e.nodeType&&"none"!=getComputedStyle(e).display&&"svg"!==e.tagName}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var t="__better-search-current-select",d=0;function r(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.domContainer=e.domContainer||null,this.dom=null,this.keyword="",this.blackClassName=e.blackClassName||[],this.searchDom={text:"",data:{}},this.count=0,this.domList=[],this.searchIndex=-1,this.overflowXDom=[],this.overflowYDom=[],this.initStyle()}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}(r,[{key:"initStyle",value:function(){var e;document.querySelector('style[type="betterSearch"]')||((e=document.createElement("style")).setAttribute("type","betterSearch"),e.appendChild(document.createTextNode(".__better-search-current-select{background: #FF9632 !important;}")),document.head.appendChild(e))}},{key:"search",value:function(e){if(this.domContainer&&e){this.clear(),this.keyword=e.trim();var t=document.querySelector(this.domContainer);this.dom=t,this.formatDom(t,this.keyword);for(var r=function(e,t){for(var r=[],n=e.indexOf(t);-1<n;)r.push(n),n=e.indexOf(t,n+1);return r}(this.searchDom.text,this.keyword),n=0;n<r.length;n++){for(var o=r[n],a=r[n]+this.keyword.length-1,i=Object.keys(this.searchDom.data),s=[],h=0;h<i.length;h++){var l=i[h].split("-");if(!(l[1]<o||l[0]>a)){if(l[0]<=o&&l[1]>=a){s.push(this.searchDom.data[i[h]]);break}s.push(this.searchDom.data[i[h]])}}if(s.length<2){var c=s[0];this.markDom(c,this.keyword,!0)}else{var d="",u=this.keyword.length;s.forEach(function(e){d+=e.parentNode.innerText});for(var m=d.indexOf(this.keyword),f=0;f<s.length;f++){var p="";0===f?(u-=(p=s[f].parentNode.innerText.slice(m)).length,this.markDom(s[f],p,!1)):f===s.length-1?(p=s[f].parentNode.innerText.slice(0,u),this.markDom(s[f],p,!1)):(u-=s[f].parentNode.innerText.length,this.markDom(s[f],s[f].parentNode.innerText,!1))}}}this.domList=this.getDomList(),this.count=this.domList.length,this.down()}}},{key:"clear",value:function(){this.count=0,this.searchIndex=-1;var e=document.querySelector(this.domContainer);this.rmMdrkDom(e),this.domList=[],this.searchDom={text:"",data:{}},d=0}},{key:"down",value:function(){this.searchIndex>this.count||(++this.searchIndex,this.searchIndex>=this.count&&(this.searchIndex=0,this.removeSelectClass(this.domList[this.domList.length-1])),this.resetAllSelectClass(),this.goNode(this.searchIndex))}},{key:"up",value:function(){this.searchIndex<0||(--this.searchIndex,this.searchIndex<0&&(this.searchIndex=this.domList.length-1,this.removeSelectClass(this.domList[0])),this.resetAllSelectClass(),this.goNode(this.searchIndex))}},{key:"resetAllSelectClass",value:function(){var t=this;this.domList.forEach(function(e){t.removeSelectClass(e)})}},{key:"removeSelectClass",value:function(e){e.forEach(function(e){e.classList.remove(t)})}},{key:"goNode",value:function(e){var f=this;this.domList[e].forEach(function(e){var t,r,n=f.getParentNodeList(e),o=e.getBoundingClientRect(),a=null,i=!0,s=!1,h=void 0;try{for(var l,c=n[Symbol.iterator]();!(i=(l=c.next()).done);i=!0){var d=l.value,u=f.overflowYDom.indexOf(d),m=f.overflowXDom.indexOf(d);if(-1<u){a=f.overflowYDom[u];break}if(-1<m){f.overflowXDom[m];break}}}catch(e){s=!0,h=e}finally{try{!i&&c.return&&c.return()}finally{if(s)throw h}}a&&(t=a.getBoundingClientRect(),r=o.top+a.scrollTop-t.top-60,a.scrollTo(0,r||0)),f.addSelectClass([e])})}},{key:"getParentNodeList",value:function(e){var t=[],r=e;for(t.push(e);!r.isEqualNode(this.dom);)t.push(r.parentNode),r=r.parentNode;return t}},{key:"addSelectClass",value:function(e){e.forEach(function(e){e.classList.add(t)})}},{key:"rmMdrkDom",value:function(e){e.querySelectorAll("mark.search-highlight").forEach(function(e){e.parentNode&&e.parentNode.querySelector("template[search-highlight]")&&(e.parentNode.innerHTML=e.parentNode.querySelector("template[search-highlight]").innerHTML)})}},{key:"getDomList",value:function(){var e=document.querySelectorAll("mark.search-highlight"),r={};return e.forEach(function(e){var t=e.getAttribute("mark-id");r[t]||(r[t]=[]),r[t].push(e)}),Object.values(r)}},{key:"markDom",value:function(o,e,a){var t,r,n,i,s,h,l,c;o.parentNode&&e&&(1<o.parentNode.childNodes.length&&(r=(t=o).parentNode,n=r.childNodes[Array.apply(null,r.childNodes).indexOf(t)-1],i=r.removeChild(t),(s=document.createElement("span")).appendChild(i),n?(r.appendChild(s),n.after(s)):r.prepend(s),o=i),h=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"ig"),(l=o.data.match(h))&&(c=o.data.split(h),o.parentNode.innerHTML=c.reduce(function(e,t,r){var n=e+t+(r<c.length-1?'<mark class="search-highlight" mark-id="'+d+'">'+l[r]+"</mark>":"<template search-highlight>"+o.data+"</template>");return a&&d++,n},"")))}},{key:"formatDom",value:function(e,a){var i=this,t=e.childNodes;t.length&&a.length&&t.forEach(function(e){if(1===e.nodeType||3===e.nodeType)if(s(e)&&(e.scrollHeight>e.clientHeight&&i.overflowYDom.push(e),e.scrollWidth>e.clientWidth&&i.overflowXDom.push(e)),s(e)&&(n=e,o=i.blackClassName,n.classList&&!o.filter(function(e){try{return-1<n.className.indexOf(e)}catch(e){return!1}}).length)&&!/(script|style|template)/i.test(e.tagName))i.formatDom(e,a);else if(3===e.nodeType)for(var t=0;t<a.length;t++)if(-1<e.data.indexOf(a[t])){var r=i.searchDom.text.length;i.searchDom.text=i.searchDom.text+e.parentNode.innerText,i.searchDom.data[r+"-"+(i.searchDom.text.length-1)]=e;break}var n,o})}}]),r});
