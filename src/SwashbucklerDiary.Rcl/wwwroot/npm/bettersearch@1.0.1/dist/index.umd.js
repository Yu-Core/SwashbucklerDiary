!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).BetterSearch=t()}(this,function(){"use strict";function s(e){return 1===e.nodeType&&"none"!=getComputedStyle(e).display&&"svg"!==e.tagName}function d(e){return e.replace(/[&<>"']/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]})}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var t="__better-search-current-select",u=0;function n(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.domContainer=e.domContainer||null,this.dom=null,this.keyword="",this.blackClassName=e.blackClassName||[],this.searchDom={text:"",data:{}},this.count=0,this.domList=[],this.searchIndex=-1,this.overflowXDom=[],this.overflowYDom=[],this.initStyle()}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}(n,[{key:"initStyle",value:function(){var e;document.getElementById("better-search-style")||((e=document.createElement("style")).id="better-search-style",e.textContent="."+t+"{background:#FF9632!important;}",document.head.appendChild(e))}},{key:"search",value:function(e){if(this.domContainer&&e){this.clear(),this.keyword=e.trim();var t=document.querySelector(this.domContainer);this.dom=t,this.formatDom(t,this.keyword);for(var n=function(e,t){for(var n=[],r=e.indexOf(t);-1<r;)n.push(r),r=e.indexOf(t,r+1);return n}(this.searchDom.text,this.keyword),r=0;r<n.length;r++){for(var i=n[r],a=n[r]+this.keyword.length-1,o=Object.keys(this.searchDom.data),s=[],h=0;h<o.length;h++){var l=o[h].split("-");if(!(l[1]<i||l[0]>a)){if(l[0]<=i&&l[1]>=a){s.push(this.searchDom.data[o[h]]);break}s.push(this.searchDom.data[o[h]])}}if(s.length<2){var c=s[0];this.markDom(c,this.keyword,!0)}else{var d="",u=this.keyword.length;s.forEach(function(e){d+=e.parentNode.innerText});for(var m=d.indexOf(this.keyword),f=0;f<s.length;f++){var p="";0===f?(u-=(p=s[f].parentNode.innerText.slice(m)).length,this.markDom(s[f],p,!1)):f===s.length-1?(p=s[f].parentNode.innerText.slice(0,u),this.markDom(s[f],p,!1)):(u-=s[f].parentNode.innerText.length,this.markDom(s[f],s[f].parentNode.innerText,!1))}}}this.domList=this.getDomList(),this.count=this.domList.length,this.down()}}},{key:"clear",value:function(){this.count=0,this.searchIndex=-1;var e=document.querySelector(this.domContainer);this.rmMdrkDom(e),this.domList=[],this.searchDom={text:"",data:{}},u=0}},{key:"down",value:function(){this.searchIndex>this.count||(++this.searchIndex,this.searchIndex>=this.count&&(this.searchIndex=0,this.removeSelectClass(this.domList[this.domList.length-1])),this.resetAllSelectClass(),this.goNode(this.searchIndex))}},{key:"up",value:function(){this.searchIndex<0||(--this.searchIndex,this.searchIndex<0&&(this.searchIndex=this.domList.length-1,this.removeSelectClass(this.domList[0])),this.resetAllSelectClass(),this.goNode(this.searchIndex))}},{key:"resetAllSelectClass",value:function(){var t=this;this.domList.forEach(function(e){t.removeSelectClass(e)})}},{key:"removeSelectClass",value:function(e){e&&e.forEach(function(e){e.classList.remove(t)})}},{key:"goNode",value:function(e){var t,n=this.domList[e];n&&((t=n[0])&&(t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView()),this.addSelectClass(n))}},{key:"getParentNodeList",value:function(e){var t=[],n=e;for(t.push(e);!n.isEqualNode(this.dom);)t.push(n.parentNode),n=n.parentNode;return t}},{key:"addSelectClass",value:function(e){e.forEach(function(e){e.classList.add(t)})}},{key:"rmMdrkDom",value:function(e){e.querySelectorAll("mark.search-highlight").forEach(function(e){e.parentNode&&e.parentNode.querySelector("template[search-highlight]")&&(e.parentNode.innerHTML=e.parentNode.querySelector("template[search-highlight]").innerHTML)})}},{key:"getDomList",value:function(){var e=document.querySelectorAll("mark.search-highlight"),n={};return e.forEach(function(e){var t=e.getAttribute("mark-id");n[t]||(n[t]=[]),n[t].push(e)}),Object.values(n)}},{key:"markDom",value:function(i,e,a){var t,n,r,o,s,h,l,c;i.parentNode&&e&&(1<i.parentNode.childNodes.length&&(n=(t=i).parentNode,r=n.childNodes[Array.apply(null,n.childNodes).indexOf(t)-1],o=n.removeChild(t),(s=document.createElement("span")).appendChild(o),r?(n.appendChild(s),r.after(s)):n.prepend(s),i=o),h=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"ig"),(l=i.data.match(h))&&(c=i.data.split(h),i.parentNode.innerHTML=c.reduce(function(e,t,n){var r=e+d(t)+(n<c.length-1?'<mark class="search-highlight" mark-id="'+u+'">'+d(l[n])+"</mark>":"<template search-highlight>"+d(i.data)+"</template>");return a&&u++,r},"")))}},{key:"formatDom",value:function(e,a){var o=this,t=e.childNodes;t.length&&a.length&&t.forEach(function(e){if(1===e.nodeType||3===e.nodeType)if(s(e)&&(e.scrollHeight>e.clientHeight&&o.overflowYDom.push(e),e.scrollWidth>e.clientWidth&&o.overflowXDom.push(e)),s(e)&&(r=e,i=o.blackClassName,r.classList&&!i.filter(function(e){try{return-1<r.className.indexOf(e)}catch(e){return!1}}).length)&&!/(script|style|template)/i.test(e.tagName))o.formatDom(e,a);else if(3===e.nodeType)for(var t=0;t<a.length;t++)if(-1<e.data.indexOf(a[t])){var n=o.searchDom.text.length;o.searchDom.text=o.searchDom.text+e.parentNode.innerText,o.searchDom.data[n+"-"+(o.searchDom.text.length-1)]=e;break}var r,i})}}]),n});
